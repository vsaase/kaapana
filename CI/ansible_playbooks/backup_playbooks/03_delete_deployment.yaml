---
- hosts: localhost
  gather_facts: no
  vars_prompt:
    - name: target_host
      prompt: please enter the target host IP
      default: "10.128.129.79"
      private: no

  tasks:
    - add_host:
        name: "{{ target_host }}"
        groups: os_server

- name: Delete platform
  hosts: os_server
  strategy: free
  remote_user: root
  vars_prompt:
    - name: "project_config"
      prompt: "Which project configuration should be used?"
      default: "project_config_jip.yaml"
      private: no

  vars:
    KAAPANA_HOME: "../../"
  vars_files:
  - "{{ KAAPANA_HOME }}/CI/ansible_playbooks/project_configs/{{ project_config }}"

  tasks:
  - name: Check Helm deployments 
    command: helm ls
    register: deployments
    until: deployments.rc == 0
    retries: 5
    delay: 3

  - name: Delete project chart
    command: helm del {{ project_name }}
    when: deployments.stdout.find(project_name) != -1

  - name: Wait until namespaces are removed
    shell: /bin/bash -i -c "kubectl get namespaces | grep -E --line-buffered 'flow-jobs|flow|base|monitoring|store' | cut -d' ' -f1"
    register: deployment_removed
    until: deployment_removed.stdout == '' and deployment_removed.stderr == ''
    failed_when: deployment_removed.stdout != '' and deployment_removed.stderr != ''   
    retries: 50
    delay: 3

  - name: Wait until all pods are terminated
    shell: /bin/bash -i -c "kubectl get pods --all-namespaces | grep -E --line-buffered 'Terminating' | cut -d' ' -f1"
    register: deployment_terminated
    until: deployment_terminated.stdout == '' and deployment_terminated.stderr == ''
    failed_when: deployment_terminated.stdout != '' and deployment_terminated.stderr != ''   
    retries: 50
    delay: 3

  - name: RESULT
    debug:
      msg: "DEPLOYMENT REMOVED SUCCESSFULLY"
  
  - name: RETURN
    debug:
      msg: "OK"
